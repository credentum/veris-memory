name: Sentinel Comprehensive Tests (CI/CD)

on:
  pull_request:
    paths:
      - 'src/monitoring/sentinel/**'
      - 'src/mcp_server/**'
      - 'src/storage/**'
      - 'tests/monitoring/**'
  push:
    branches:
      - main
      - develop
  workflow_dispatch:  # Allow manual triggering

jobs:
  s3-full-paraphrase-matrix:
    name: S3 Full Paraphrase Matrix (5×5=25 tests)
    runs-on: ubuntu-latest
    timeout-minutes: 30

    services:
      neo4j:
        image: neo4j:5.13
        env:
          NEO4J_AUTH: neo4j/test_password_12345
          NEO4J_PLUGINS: '["apoc"]'
        ports:
          - 7687:7687
          - 7474:7474
        options: >-
          --health-cmd "cypher-shell -u neo4j -p test_password_12345 'RETURN 1'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      qdrant:
        image: qdrant/qdrant:v1.7.0
        ports:
          - 6333:6333
        options: >-
          --health-cmd "curl -f http://localhost:6333/health || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install -r requirements-dev.txt

      - name: Start MCP server in background
        env:
          NEO4J_URI: bolt://localhost:7687
          NEO4J_USER: neo4j
          NEO4J_PASSWORD: test_password_12345
          QDRANT_URL: http://localhost:6333
          REDIS_URL: redis://localhost:6379
          ENVIRONMENT: test
          ADMIN_API_KEY: test_admin_key_for_ci
        run: |
          python -m src.mcp_server.main &
          echo $! > mcp_server.pid
          sleep 10  # Wait for server to start

      - name: Run S3 Full Paraphrase Matrix
        env:
          TARGET_BASE_URL: http://localhost:8000
          SENTINEL_API_KEY: test_sentinel_key_for_ci
        run: |
          pytest tests/monitoring/test_paraphrase_robustness.py \
            --cov=src/monitoring/sentinel/checks/s3_paraphrase_robustness \
            --cov-report=xml \
            --cov-report=term \
            -v

      - name: Upload S3 coverage
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage.xml
          flags: s3-paraphrase-full
          name: s3-full-matrix

      - name: Stop MCP server
        if: always()
        run: |
          if [ -f mcp_server.pid ]; then
            kill $(cat mcp_server.pid) || true
          fi

  s9-graph-intent-comprehensive:
    name: S9 Graph Intent Validation (8 comprehensive tests)
    runs-on: ubuntu-latest
    timeout-minutes: 30

    services:
      neo4j:
        image: neo4j:5.13
        env:
          NEO4J_AUTH: neo4j/test_password_12345
          NEO4J_PLUGINS: '["apoc"]'
        ports:
          - 7687:7687
          - 7474:7474

      qdrant:
        image: qdrant/qdrant:v1.7.0
        ports:
          - 6333:6333

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install -r requirements-dev.txt

      - name: Start MCP server
        env:
          NEO4J_URI: bolt://localhost:7687
          NEO4J_USER: neo4j
          NEO4J_PASSWORD: test_password_12345
          QDRANT_URL: http://localhost:6333
          REDIS_URL: redis://localhost:6379
          ENVIRONMENT: test
        run: |
          python -m src.mcp_server.main &
          echo $! > mcp_server.pid
          sleep 10

      - name: Run S9 Comprehensive Graph Intent Tests
        env:
          TARGET_BASE_URL: http://localhost:8000
          SENTINEL_API_KEY: test_sentinel_key_for_ci
        run: |
          pytest tests/monitoring/test_graph_intent.py \
            --cov=src/monitoring/sentinel/checks/s9_graph_intent \
            --cov-report=xml \
            --cov-report=term \
            -v

      - name: Upload S9 coverage
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage.xml
          flags: s9-graph-intent-full
          name: s9-comprehensive

      - name: Stop MCP server
        if: always()
        run: |
          kill $(cat mcp_server.pid) || true

  s10-pipeline-comprehensive:
    name: S10 Content Pipeline (7 stage tests)
    runs-on: ubuntu-latest
    timeout-minutes: 30

    services:
      neo4j:
        image: neo4j:5.13
        env:
          NEO4J_AUTH: neo4j/test_password_12345
          NEO4J_PLUGINS: '["apoc"]'
        ports:
          - 7687:7687
          - 7474:7474

      qdrant:
        image: qdrant/qdrant:v1.7.0
        ports:
          - 6333:6333

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install -r requirements-dev.txt

      - name: Start MCP server
        env:
          NEO4J_URI: bolt://localhost:7687
          NEO4J_USER: neo4j
          NEO4J_PASSWORD: test_password_12345
          QDRANT_URL: http://localhost:6333
          REDIS_URL: redis://localhost:6379
          ENVIRONMENT: test
        run: |
          python -m src.mcp_server.main &
          echo $! > mcp_server.pid
          sleep 10

      - name: Run S10 Comprehensive Pipeline Tests
        env:
          TARGET_BASE_URL: http://localhost:8000
          SENTINEL_API_KEY: test_sentinel_key_for_ci
        run: |
          pytest tests/monitoring/test_content_pipeline.py \
            --cov=src/monitoring/sentinel/checks/s10_content_pipeline \
            --cov-report=xml \
            --cov-report=term \
            -v

      - name: Upload S10 coverage
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage.xml
          flags: s10-pipeline-full
          name: s10-comprehensive

      - name: Stop MCP server
        if: always()
        run: |
          kill $(cat mcp_server.pid) || true

  summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [s3-full-paraphrase-matrix, s9-graph-intent-comprehensive, s10-pipeline-comprehensive]
    if: always()

    steps:
      - name: Check all tests passed
        run: |
          echo "### Sentinel Comprehensive Tests Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This workflow runs the full test suites that were moved out of runtime monitoring:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **S3 Full Paraphrase Matrix**: 5 topics × 5 variations = 25 tests" >> $GITHUB_STEP_SUMMARY
          echo "- **S9 Graph Intent**: All 8 comprehensive graph validation tests" >> $GITHUB_STEP_SUMMARY
          echo "- **S10 Content Pipeline**: All 7 pipeline stage tests" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Runtime monitoring** now uses optimized smoke tests (18 queries/cycle)" >> $GITHUB_STEP_SUMMARY
          echo "**CI/CD testing** validates comprehensive functionality on code changes" >> $GITHUB_STEP_SUMMARY
