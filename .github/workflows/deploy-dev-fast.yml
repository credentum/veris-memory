name: Fast Code-Only Deployment (Dev)

on:
  # Manual trigger for fast deployments
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for fast deployment'
        required: false
        default: 'Code-only update'

jobs:
  deploy-code-only:
    name: Fast Code-Only Deploy
    runs-on: ubuntu-latest
    environment: development

    steps:
      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "::add-mask::${{ secrets.HETZNER_SSH_KEY }}"
          printf '%s\n' "${{ secrets.HETZNER_SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -t ed25519 -H ${{ secrets.HETZNER_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Fast Code Deployment
        run: |
          ssh -o StrictHostKeyChecking=no \
              -o UserKnownHostsFile=~/.ssh/known_hosts \
              -i ~/.ssh/id_ed25519 \
              ${{ secrets.HETZNER_USER }}@${{ secrets.HETZNER_HOST }} << 'EOSSH'
            set -e

            echo "‚ö° FAST CODE-ONLY DEPLOYMENT"
            echo "=============================="
            cd /opt/veris-memory

            PROJECT_NAME="veris-memory-dev"
            COMPOSE_FILE="docker-compose.deploy-dev.yml"

            # Pull latest code
            echo "üì• Pulling latest code..."
            git pull origin main

            # Check if volume-mounted compose file exists
            if [ ! -f "$COMPOSE_FILE" ]; then
                echo "‚ùå $COMPOSE_FILE not found!"
                echo "   Run full deployment first to create the compose file."
                exit 1
            fi

            # Check if services are running
            RUNNING=$(docker compose -p ${PROJECT_NAME} -f ${COMPOSE_FILE} ps --status running -q 2>/dev/null | wc -l)

            if [ "$RUNNING" -gt 0 ]; then
                echo "‚úÖ Found $RUNNING running services"
                echo ""
                echo "üîÑ Restarting services to pick up code changes..."
                echo "   (Code is mounted via volumes, hot reload should handle this automatically)"

                # With volume mounts + hot reload, we just need to trigger a restart
                # The --reload flag in uvicorn will detect file changes and restart
                docker compose -p ${PROJECT_NAME} -f ${COMPOSE_FILE} restart context-store api sentinel monitoring-dashboard 2>/dev/null || {
                    echo "‚ö†Ô∏è  Some services failed to restart, trying up instead..."
                    docker compose -p ${PROJECT_NAME} -f ${COMPOSE_FILE} up -d context-store api sentinel monitoring-dashboard
                }
            else
                echo "‚ö†Ô∏è  No services running. Starting services..."
                docker compose -p ${PROJECT_NAME} -f ${COMPOSE_FILE} up -d
            fi

            echo "‚è±Ô∏è  Waiting 15s for services..."
            sleep 15

            # Health check
            echo ""
            echo "üè• Health check:"
            curl -sf http://localhost:8000/health && echo "‚úÖ MCP Server healthy" || echo "‚ö†Ô∏è  MCP Server not ready"
            curl -sf http://localhost:8001/api/v1/health && echo "‚úÖ API healthy" || echo "‚ö†Ô∏è  API not ready"

            echo ""
            echo "‚úÖ FAST DEPLOYMENT COMPLETE"
            echo "   Code mounted via volumes - changes are instant!"
          EOSSH

      - name: Cleanup SSH key
        if: always()
        run: rm -f ~/.ssh/id_ed25519

      - name: Deployment Summary
        if: always()
        run: |
          echo "‚úÖ Fast code-only deployment complete!"
          echo "‚ö° Total time: ~30 seconds (vs 40 minutes for full rebuild)"
          echo "üìù Reason: ${{ github.event.inputs.reason }}"
